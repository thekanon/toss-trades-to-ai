# transaction-to-json.js

이 코드는 토스 거래내역을 파싱하여 JSON으로 변환하는 스크립트입니다.

## 전체 흐름

1. 입력 JSON 파일을 읽고 각 거래 레코드를 파싱
2. 국내거래인지 해외거래인지에 따라 각각 다른 조건으로 파싱(해외거래는 split(" ")로 나누면 최소 23개 필드가 나옴)
3. 거래 타입별로 데이터를 구조화
4. 결과를 JSON 파일로 저장

## 입력 데이터 유형

### 컬럼 구조

1. 국내 거래 컬럼
   [
   "거래일자",
   "거래구분",
   "종목명(종목코드)",
   "환율",
   "거래수량",
   "거래대금",
   "단가",
   "수수료",
   "거래세",
   "제세금",
   "변제/연체합",
   "잔고",
   "잔액
   ]

2. 해외 거래 컬럼
   [
   "거래일자",
   "거래구분",
   "종목명(종목코드)",
   "환율",
   "거래수량",
   "거래대금",
   "단가",
   "수수료",
   "제세금",
   "변제/연체합",
   "잔고",
   "잔액"
   ]

3. 거래 유형 종류
   {
   "환전원화출금", "환전원화입금",
   "구매", "판매","1주이벤트입고","배당금입금","액면분할병합출고","액면분할단주대금입금",
   "이체입금","이체출금","이체출금(우리은행), "이체출금(토스뱅크)"
   "이자입금",
   "환전외화입금","환전외화출금",
   "구매", "판매","외화증권배당금입금", "해외주식이벤트입고","소수점이벤트입고","주식분할출고","주식분할입고","공개매수출고","공개매수입고","외화공개매수입금",
   }

### 국내 거래 처리 방법

1. 환전원화출금, 환전원화입금

- "2024.05.06 환전원화출금 김토스 1,365.09 0 26,605 0 0 0 0 0 0 1,511,685",
- "2024.12.19 환전원화입금 김토스 1,449.43 0 14,621,803 0 0 0 0 0 0 14,627,359",
- 그대로 split(" ")로 나누면 13개 필드가 나옴

2. 구매, 판매, 1주이벤트입고, 배당금입금, 액면분할병합출고

- "2024.05.09 구매 KODEX 미국S&P500(A379800) 5 79,775 15,955 10 0 0 0 100 1,118,737",
- "2024.05.14 판매 KODEX 미국S&P500(A379800) 100 1,620,000 16,200 240 0 15,050 0 0 4,042,502",
- "2021.05.31 1주이벤트입고 NGS, 그래디언트(A035080) 1 0 5,140 0 0 0 0 1 0",
- "2022.05.20 액면분할병합출고 그래디언트(A035080) 1 0 5,140 0 0 0 0 0 0",
- "2022.05.27 액면분할단주대금입금 그래디언트(A035080) 0 4,370 0 0 0 0 0 0 536,450"
- 환율이 없고, 종목코드가 괄호로 묶여있음
- 종목명에 공백이 있을 수 있음

3. "이체입금","이체출금","이체출금(우리은행), "이체출금(토스뱅크)"

- "2024.10.27 이체입금 김토스 0 2,000,000 0 0 0 0 0 0 2,578,324",
- "2023.01.18 이체출금(우리은행) 김토스 0 2,000,000 0 0 0 0 0 0 242,370",
- "2023.01.18 이체출금(토스뱅크) 김토스 0 2,000,000 0 0 0 0 0 0 242,370",
- 환율이 없고, 종목명에 공백이 없음
- 이체출금의 경우 괄호 안에 은행명이 있음

4. 이자입금

- "2024.05.31 이자입금 0 2,158 0 0 0 330 0 0 3,706,693"
- 환율, 종목명 없음

### 해외 거래 처리 방법

1. 환전외화입금, 환전외화출금

- "2024.02.05 환전외화입금 1,333.92 0 4,999,999 ($ 3,748.36) 0 ($ 0.00) 0 ($ 0.00) 0 ($ 0.00) 0 ($ 0.00) 0 7,282,571 ($ 5,459.54)"
- "2024.12.19 환전외화출금 1,449.43 0 14,621,802 ($ 10,088.00) 0 ($ 0.00) 0 ($ 0.00) 0 ($ 0.00) 0 ($ 0.00) 0 6,405,981 ($ 4,419.67)"
- 종목명이 없음
- 매핑은 아래와 같음
  거래일자: 0번 인덱스 → "2024.02.05"
  거래구분: 1번 인덱스 → "환전외화입금"
  종목명(종목코드): null (해당 데이터 없음)
  환율: 2번 인덱스 → "1,333.92"
  거래수량: 3번 인덱스 → "0"
  거래대금: 4+5+6번 결합 → "4,999,999 ($ 3,748.36)"
  단가: 7+8+9번 결합 → "0 ($ 0.00)"
  수수료: 10번 인덱스 → "0"
  제세금: 14번 인덱스 → "0"
  변제/연체합: 표시된 부분 없음, 기본값 "0"
  잔고: 19번 인덱스 → "7,282,571"
  잔액: 20+21+22번 결합 → "($ 5,459.54)"

2. "구매", "판매","외화증권배당금입금", "해외주식이벤트입고","소수점이벤트입고","주식분할출고","주식분할입고","공개매수출고","공개매수입고","외화공개매수입금"

- "2023.11.01 외화증권배당금입금 SPDR S&P500 ETF 트러스트 (US78462F1030) 1,349.60 0 6,977 ($ 5.17) 0 ($ 0.00) 0 ($ 0.00) 1,228 ($ 0.91) 0 ($ 0.00) 0 5,553,145 ($ 4,114.66)",
- "2023.11.03 구매 SPDR S&P500 ETF 트러스트 (US78462F1030) 1,343.20 0.177369 98,832 ($ 73.579756) 557,213 ($ 414.84) 94 ($ 0.07) 0 ($ 0.00) 0 ($ 0.00) 5.039226 5,398,253 ($ 4,018.95)",
- "2024.05.24 판매 SPDR S&P500 ETF 트러스트 (US78462F1030) 1,364.50 2.36392 1,709,051 ($ 1,252.511192) 722,973 ($ 529.845) 1,705 ($ 1.25) 54 ($ 0.04) 0 ($ 0.00) 7.091763 5,447,902 ($ 3,992.60)"
- 종목명에 공백이 있을 수 있음(SPDR S&P500 ETF 트러스트 (US78462F1030) 이때 괄호로 종목코드까지 포함해야함)
- 이후 필드들은 위와 동일하게 처리(종목명의 공백 다음 인덱스부터 연속으로 매핑)

## 주요 함수

### 1. `isNumeric(tok)`

- 숫자 형식의 문자열인지 확인 (콤마가 포함된 숫자도 인식)
- `null`, `1,234`, `1.23` 등의 형식 지원

### 2. `parseNumericBlock(tokens)`

- 연속된 9개의 숫자 블록을 찾는 함수
- 토스 거래내역의 각 행이 날짜, 거래구분 후 9개 숫자 필드를 가진다는 전제

## 처리하는 거래 타입

### 1. 외화증권배당금입금

- 외국 증권 배당금 처리
- 미국 종목코드(US~~) 식별 후 이름, 환율, 배당금 정보 추출

### 2. 환전 거래 (원화/외화 변환)

- `환전원화출금`, `환전외화입금` 등
- 환율과 거래 금액 정보 파싱

### 3. 매매 거래 (구매/판매)

- 국내/해외 주식 구매/판매
- 종목코드, 수량, 단가, 수수료 등 정보 추출

### 4. 기업 액션

- 주식 분할, 병합, 이벤트 처리
- 배당금 입금 등 11가지 기업 액션 타입 지원

### 5. 이체 및 이자

- 이체 입/출금
- 이자 입금 처리

## 출력 형식

모든 거래는 다음 필드를 포함하는 표준화된 JSON 객체로 변환:

```json
{
  "거래일자": "2023.05.04",
  "거래구분": "이체입금",
  "종목명": "김토스",
  "환율": null,
  "거래수량": "0",
  "거래대금": "100000",
  "단가": "0",
  "수수료": "0",
  "거래세": "0",
  "제세금": "0",
  "변제_연체합": "0",
  "잔고": "0",
  "잔액": "100000"
}
```

## 주요 특징

1. **견고한 처리**: 다양한 거래 형식을 타입별로 분류하여 적절히 파싱
2. **에러 처리**: parseNumericBlock에서 9개 숫자 블록을 찾을 수 없으면 에러 발생
3. **유연성**: 각 거래 타입별 특수 케이스 처리 (예: 외국 증권은 환율 필드 추가)

이 코드는 토스 앱에서 내보낸 거래내역 텍스트를 구조화된 데이터로 변환하여 재무 분석이나 다른 시스템에서 쉽게 활용할 수 있도록 만드는 도구입니다.
